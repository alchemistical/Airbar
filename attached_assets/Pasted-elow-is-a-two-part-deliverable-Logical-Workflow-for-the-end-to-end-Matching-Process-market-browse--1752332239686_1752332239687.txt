elow is a two-part deliverable:
Logical Workflow for the end-to-end Matching Process (market-browse â†’ request â†’ escrow â†’ confirmation).


Replit-ready prompt that breaks the build into clear routes, components, API hooks, and dev tickets.



1  Logical Workflow â€” â€œMatch & Escrowâ€ ğŸ”—
sequenceDiagram
  participant S as Sender
  participant M as Marketplace UI
  participant T as Traveler
  participant P as Payment (Stripe)
  participant E as Escrow Service
  participant DB as DB/API

  S->>M: Browse Trips
  M->>DB: GET /trips?filters
  DB-->>M: List of trips
  S->>M: View Trip Detail
  M->>DB: GET /trip/:id
  S->>M: "Request Match" (choose reward)
  M->>DB: POST /match-requests
  T-->>M: Notification badge + detail page
  T->>M: Accept or Decline
  T-->>DB: PATCH /match-requests/:id status=accepted
  Note over S,M: If accepted â†’
  S->>M: Redirect to PaymentCheckout
  M->>P: Create Checkout Session (reward amount)
  P-->>S: Card entry â†’ success
  P-->>E: Hold funds in escrow
  E-->>DB: webhook /payment_intent.succeeded
  DB-->>M: Update Match status = confirmed
  S-->>T: Chat opens, Tracking starts
Status States
Entity
States
Match Request
pending â†’ accepted / declined
Payment
pending â†’ succeeded / failed
Escrow
held â†’ released / refunded
Match (order)
confirmed â†’ picked_up â†’ in_transit â†’ delivered â†’ completed

Timeout & Escrow Rules
Event
Timeout
Auto-action
Traveler doesnâ€™t accept within 24 h
Match Request â†’ expired


Sender fails to pay within 1 h after acceptance
Match Request â†’ cancelled


Delivery not confirmed 7 days after ETA
Escrow â†’ dispute flag




2  Replit Implementation ğŸš€
Routes
/marketplace
  â”œâ”€ /marketplace/trips           (Browse Trips)
/marketplace/trips/:id            (Trip Detail)
/marketplace/parcels              (Browse Parcels)
/marketplace/parcels/:id          (Parcel Detail)
  
/match-requests                   (My Requests list)
/match-requests/:id               (Detail & payment step)

/checkout/:matchId                (Stripe Checkout page)
Core Components
Component
Purpose
TripCard / ParcelCard
marketplace listings
FilterSidebar
date, route, reward sliders
MatchRequestModal
choose reward, send message
MatchStatusBadge
pending / accepted / paid
EscrowBanner
Shows â€œFunds held âœ“â€
StripeCheckout
embeds Stripe Elements

API Endpoints
Verb
Endpoint
Notes
GET
/trips, /parcels
filters & pagination
POST
/match-requests
body: tripId / parcelId / reward
PATCH
/match-requests/:id
accept / decline
POST
/payments/checkout-session
Stripe session
POST
/webhooks/stripe
listen â€œpayment_intent.succeededâ€


Dev Tickets
ID
Task
AC
MP-01
Scaffold /marketplace/* pages with filter sidebar
List renders, filters on change
MP-02
TripCard, ParcelCard responsive design
Hover shows CTA â€œRequest Matchâ€
MR-03
MatchRequestModal (step: reward â†’ note)
POST returns 201 with matchId
MR-04
Traveler â€œAccept / Declineâ€ buttons on request detail
Status updates; toast emitted
PAY-05
Stripe Checkout Page (/checkout/:matchId)
On success â†’ /match-requests/:id
ESC-06
EscrowBanner component (reads escrow state)
Shows green badge when held
NTF-07
Socket / Pusher event â€œmatch.acceptedâ€
Bell count increment
CRON-08
Job to expire unpaid matches after 1 h
Status â†’ cancelled
QA-09
Cypress flow: senderâ†’matchâ†’payâ†’escrow held
All assertions pass

